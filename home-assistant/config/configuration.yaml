
# Configure a default setup of Home Assistant (frontend, api, etc)
default_config:

discovery:
  ignore:
    - homekit

# Text to speech
tts:
  - platform: google_translate

group: !include groups.yaml
automation: !include automations.yaml
script: !include scripts.yaml
scene: !include scenes.yaml

recorder:
  purge_keep_days: 30
  commit_interval: 60

wake_on_lan:

sensor:
  - platform: citybikes
    radius: 1000

  - platform: entur_public_transport
    show_on_map: true
    number_of_departures: 3
    stop_ids:
      - 'NSR:StopPlace:58194' # Ã˜kern T
      - 'NSR:StopPlace:5914'  # Ã˜kern aldershjem
    line_whitelist:
      - 'RUT:Line:5'
      - 'RUT:Line:60'
  
  - platform: integration
    source: sensor.apartment_energy_usage
    name: Electricity kWh
    unit_prefix: k
    round: 2

mqtt:
  sensor:
    - name: "Apartment Energy Usage"
      # Consider apparent power, which might be named Realpower2 due to hardware outputting version 2 of http://lechacal.com/wiki/index.php?title=RPICT3V1#Default_Data_Output
      # and https://github.com/ned-kelly/docker-lechacal-homeassistant seeming to parse as if it were version 1.
      state_topic: "apartment_power/sensor/RPICT3V1_Realpower1"
      unit_of_measurement: "Watt"
      value_template: "{{ value | int }}"

template:
  - sensor:      
      - name: TV Volume
        unit_of_measurement: "%"
        state: "{{ state_attr('media_player.living_room_tv','volume_level') | multiply(100) | round }}"

      - name: "Precipitation probability"
        unit_of_measurement: "%"
        state: "{{ state_attr('weather.home','forecast')[0].precipitation_probability | round }}"
      
      - name: "Electricity Price"
        unit_of_measurement: "Ã˜re"
        state: "{{ states('sensor.tibber') | multiply(100) | round }}"
      
      - name: "Electricity Price Level"
        state: "{{ state_attr('sensor.tibber','price_level') | capitalize | replace('_',' ') }}"
      
      - name: "First subway"
        icon: mdi:subway-variant
        unit_of_measurement: "min"
        state: "{{ states('sensor.entur_okern_platform_2') }}"
      
      - name: "Next subway"
        icon: mdi:subway-variant
        unit_of_measurement: "min"
        state: "{{ state_attr('sensor.entur_okern_platform_2','next_due_in') | replace('min','') }}"
      
      - name: Electricity price emoji
        state: >
          {% if state_attr('sensor.tibber','price_level') == "VERY_CHEAP" %}
            ğŸ˜„
          {% elif state_attr('sensor.tibber','price_level') == "CHEAP" %}
            ğŸ™‚
          {% elif state_attr('sensor.tibber','price_level') == "NORMAL" %}
            ğŸ˜
          {% elif state_attr('sensor.tibber','price_level') == "EXPENSIVE" %}
            ğŸ˜ 
          {% elif state_attr('sensor.tibber','price_level') == "VERY_EXPENSIVE" %}
            ğŸ¤¬
          {% else %}
            ?
          {% endif %}
      
      - name: Low batteries
        icon: mdi:battery-10
        state: >
          {% set ns = namespace(below=[]) %}
          {% for s in states.sensor 
            if s.entity_id.endswith('battery_level') and s.state != 'unavailable' and s.state != 'unknown' and s.state|int < 3 %}
          {% set ns.below = ns.below + [s.entity_id] %}
          {% endfor %}
          {% if ns.below | count ==  0  %}
            none
          {% else %}
            {{ ns.below | join('\n') }}{% set ns = namespace(below=[]) %}
          {% endif %}
